---
title: "Ineq Pset 3"
author: "Julia Du"
date: "`r lubridate::today()`"
output: pdf_document
---

## Load necessary libraries
```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(lubridate)
library(broom)
library(glue)
library(ivreg)
library(lmtest)
library(sandwich)
library(moderndive)
library(kableExtra)
library(tinytex)
library(stargazer)
library(fastDummies)
library(lfe)

theme_set(theme_minimal())
```

## Question 4a

The causal relationship of interest is the effect of income (where your income is either increased by EITC or not) on infant health outcomes, specifically infant birth weight. 

The structural equation is: 

$$Y_{ipjst} = \beta_0 + \beta_1(Income_{ipjst}) + \varepsilon_{ipjst}$$ 
where $i$ is the individual. The other subscripts will be discussed later.

## Question 4b

If we estimate the structural equation in cross-sectional data, then our estimate of the causal parameter of interest $\beta_1$ will suffer from Omitted Variable Bias (OVB) since those...
income is endogeneous because it is correlated with unobserved health care inputs (??? maybe just unobserved health). aka those with better health tend to have higher income

###?????. 
Recall: 

$$ OVB =  \beta_1^{OLS} - \beta_1 \\ = \frac{cov(Income_{ipjst}, \varepsilon_{ipjst})}{var(Income_{ipjst})}$$

So, the direction of bias depends on the sign of the covariance. In this case, it's likely our estimate is upward-biased since income tends to be positively correlated with unobserved health. 

## Question 4c (maybe just write this out)
4c(i). The 1st difference is

2nd diff is

4c(ii) parallel assumption

4c(iii)

## Question 5d

The **"reduced-form" equation** is: 
$$Y_{pjst} = \alpha + \delta After_t \times Parity2plus_p + \beta X_{st} +  \gamma_p + \eta_s + \delta_t + \phi_j + \varepsilon_{pjst}$$ 
EXPLAIN EACH TERM, HOW IT RELATES TO DD STRATEGY, & COEFF OF INTEREST (look at medium article)

where Ypjst is the fraction of low birth weight infants multiplied by 100 for the cell defined
by parity p, demographic group j, state s and effective tax year t. $\gamma_p$ is a set of dummy variables for birth order, $\eta_s$ is a set of dummy variables for state of residence, and $\delta_t$ is a set of dummy variables for effective tax year


$Y_{pjst}$ is a measure of infant health (e.g., fraction low birth weight, average birth weight) for the cell defined by parity $p$, demographic group $j$, in state $s$ for effective tax year $t$. 

$After$ equals one for effective tax years 1994 through 
1998. $X_{st}$ includes controls for unemployment rate, welfare reform and Medicaid or SCHIP eligibility, and we include fixed effects for demographic group $\phi_j$, parity $\gamma_p$, state $\eta_s$, and effective tax year $\delta_t$.

compare second- and higher order births (Parity2plus)
to first births, recalling that the EITC treatment corresponds to the number of children prior to the current bir




As you can see, there's a great deal of similarity between these two equations. The variables are: 

* $VLBW_i$ is the indicator instrumental variable on whether the newborn was classified as VLBW. 
* $VLBW_i \times(g_i - 1500)$ is how far below the cutoff of 1500 g the infant is (if they are indeed below the cutoff). 
* $(1-VLBW_I) \times (g_i-1500)$ is how far above the cutoff the infant is (if they are indeed above the cutoff).
* $g_i$ is infant i's weight in grams
* $b_t$ and $a_t$ are indicators for each year of birth t (essentially controls)
* $b_s$ and $a_s$ are indicators for each state of birth s (essentially controls)
* $X_i'$ are newborn characteristics (essentially control variables)

So similarly, the coefficients are (I will be writing just the $a$ coefficients here, but they describe the same effect on mortality as the $b$ coefficients have on health inputs): 

* $a_1$ and $b_1$ are the effect of VLBW on outcome $Y_i$ (i.e. mortality outcome for $a_1$ & health input for $b_1$)
* $a_2$ is the effect of VLBW on $Y_i$ if the infant is below the cutoff of 1500 grams 
* $a_3$ is the effect of VLBW on $Y_i$ if the infant is above the cutoff of 1500 grams. If the trends for infants on either side of the cutoff is the same, $a_2 = a_3$
* $\delta$ is the effect of the infant characteristics $X_i'$ on outcome $Y_i$


## Question 5e
Alternative specification to equation: 
$$Y_{pjst} = \alpha + \delta After_t \times Parity2plus_p + \varphi_1 After_t + \varphi_2 Parity2plus_p \\ + \beta \tilde{X}_{pjst}  + \varepsilon_{pjst}$$
DO I NEED TO EXPLAIN WHY THIS WORKS??? think i can ust think a lil bit on this...

## attempt to load data

Note: cannot upload csv to Github as file too big


```{r, message = FALSE}
q3 <- read_csv("./dataexercise_pset3/pset_dd_data.csv")

# 4g(i).A & .B: restrict sample, create dummies 
q3 <- q3 %>%
  filter(dmeducgrp %in% c("drop out", "high school"),
         marital == "not married") %>%
  filter(between(effective, 1991, 1998)) %>%
  mutate(y_lowbirth = 100 * lowbirth) %>%
  mutate(after = if_else(between(effective, 1994, 1998), 1, 0)) %>%
  mutate(
    treat1 = if_else(parvar == "1st live birth", 0, 1),
    treat2 = if_else(parvar %in% c("2nd live birth"), 1, 0),
    treat3 = if_else(parvar %in% c("3rd  birth", "4th  birth"), 1, 0)) %>%
  mutate(treat1_after = after*treat1)
# just fyi: there are 2 spaces in between the words for "3rd birth" & "4th birth"

# process data for controls
q3 <- q3 %>%
  mutate(stateres = as_factor(stateres))

fe_varlist <- q3 %>%
  select(starts_with("fe_I")) %>%
  colnames()

independ_var <- c("other", "black", "age2", "age3", "high", "racemiss", 
                  "hispanic", "hispanicmiss", "reform", "a_urate_st", 
                  "threshpreg", "as_factor(effective)", "as_factor(parvar)")

# estimate model(1) by OLS
q3_ols1 <- felm(as.formula(
  paste("y_lowbirth ~ treat1_after +",
        paste(independ_var, collapse = " + "), "+",
        paste(fe_varlist, collapse = " + "), 
        "| stateres | 0 | stateres", sep = "")), 
  data = q3, weights = q3$cellnum)

# commenting out the summary of reg results
# as we have a full stargazer summary table comin up
#q3_ols1 %>%
 # summary("robust")
``` 

so this is eqn 1 - getting pretty similar coeffs, even w/ matrix error message. 
my # of observations is right (47687)


## Equation 2
```{r, message = FALSE}
q3 <- q3 %>%
  mutate(treat2_after = after*treat2,
         treat3_after = after*treat3) 

q3_ols2 <- felm(as.formula(
  paste("y_lowbirth ~ treat2_after + treat3_after + ",
        paste(independ_var, collapse = " + "), "+",
        paste(fe_varlist, collapse = " + "), 
        "| stateres | 0 | stateres", sep = "")), 
  data = q3, weights = q3$cellnum)

#q3_ols2 %>%
 # summary("robust")

```

eitc's eff larger for fams w/ multiple kids (cuz cost more tor aise than just 1 kid)

# Model 1''
```{r, message = FALSE}
q3_data3 <- q3 %>%
  filter(parvar != "1st live birth")

q3_ols3 <- felm(as.formula(
  paste("y_lowbirth ~ treat3_after + ",
        paste(independ_var, collapse = " + "), "+",
        paste(fe_varlist, collapse = " + "), 
        "| stateres | 0 | stateres", sep = "")), 
  data = q3_data3, weights = q3_data3$cellnum)

#q3_ols3 %>%
 # summary("robust")
```


treatment group: 3rd or higher order group
control group: 2nd order birth group

## Question 4g(iv): Summary table
```{r table, results = "asis"}
stargazer(q3_ols1, q3_ols2, q3_ols3, type = "latex", 
          keep = c("treat1_after", "treat2_after", "treat3_after"), 
          title = "Question 4g(iv)", 
          dep.var.labels =c("Eqn 1", "Eqn 1'", "Eqn 1''"), 
          omit.stat =c("f","rsq","adj.rsq","ser"),
          covariate.labels =c("Parity2+ x After", "Parity=2 x After",
                              "Parity3+ x After"),
          dep.var.caption = "OLS",
          digits = 4)
```


## Question 4h
```{r}
q3_yr <- q3 %>%
  mutate(eventyr = effective - 1993) %>%
  #mutate(eventyr0 = if_else(eventyr == -2, 1, 0)) %>% # can also do this method
  mutate(eventyr0 = as.numeric(eventyr == -2),
         eventyr1 = as.numeric(eventyr == -1),
         eventyr2 = as.numeric(eventyr == 0),
         eventyr3 = as.numeric(eventyr == 1),
         eventyr4 = as.numeric(eventyr == 2),
         eventyr5 = as.numeric(eventyr == 3),
         eventyr6 = as.numeric(eventyr == 4),
         eventyr7 = as.numeric(eventyr == 5)) %>%
  #only need dummies for treat 1 since estimating model 1
  mutate(treat1_eventyr0 = treat1*eventyr0,
         treat1_eventyr1 = treat1*eventyr1,
         treat1_eventyr2 = treat1*eventyr2,
         treat1_eventyr3 = treat1*eventyr3,
         treat1_eventyr4 = treat1*eventyr4,
         treat1_eventyr5 = treat1*eventyr5,
         treat1_eventyr6 = treat1*eventyr6,
         treat1_eventyr7 = treat1*eventyr7) 

evt1_var <- names(q3_yr)[grep("treat1_e", names(q3_yr))]
  #q3_yr %>%
  #select(starts_with("treat1_e")) %>%
  #colnames()
#unsure why i'm doing this
evt1_var <- setdiff(evt1_var, "treat1_eventyr2")
  
evt_control <- c("other", "black", "age2", "age3", "high", "racemiss", 
                  "hispanic", "hispanicmiss", "reform", "a_urate_st", 
                  "threshpreg", "as_factor(eventyr)", "as_factor(parvar)")
    
q3_yr_reg <- felm(as.formula(
  paste("y_lowbirth ~ ",
        paste(evt1_var, collapse = " + "), "+",
        paste(evt_control, collapse = " + "), "+",
        paste(fe_varlist, collapse = " + "), 
        "| stateres | 0 | stateres", sep = "")), 
  data = q3_yr, weights = q3_yr$cellnum)


```
## plot fig 3a
```{r}
df.plot <- as.data.frame(matrix(ncol = 2, nrow = 8))
names(df.plot) <- c("eyear", "lowbirth2_a")
df.plot$eyear <- 1991:1998
df.plot$lowbirth2_a[1:2] <- summary(q3_yr_reg)$coefficients[1:2,1]
df.plot$lowbirth2_a[3] <- 0
df.plot$lowbirth2_a[4:8] <- summary(q3_yr_reg)$coefficients[3:7,1]

df.plot %>%
  ggplot()+
  geom_line(mapping = aes(x = eyear, y = lowbirth2_a)) +
  geom_vline(xintercept = 1993) +
  geom_hline(yintercept = 0) +
  labs(x = "Effective tax year", y = "Fraction LBW (*100)", title = "Estimates for Parity 2+ vs Parity 1")

```

no pretrend, no violation of parallel trends assumption.


```{r}
df <- read_csv("./dataexercise_pset3/pset_dd_data.csv")

df$treat1 <- as.numeric(df$parvar >= 2)
df$treat2 <- as.numeric(df$parvar == 2)
df$treat3 <- as.numeric(df$parvar >= 3)

df$stateres <- as.factor(df$stateres)
fe_ctrl_var <- names(df)[grep("fe_", names(df))]

df$eventyr <- df$effective - 1993
df$eventyr0 <- as.numeric(df$eventyr == -2)

df %>%
  select(effective, starts_with("event")) %>%
  unique()

q3 %>%
  mutate(eventyr = effective - 1993) %>%
  #mutate(eventyr0 = if_else(eventyr == -2, 1, 0)) %>%
  mutate(eventyr0 = as.numeric(eventyr == -2)) %>%
  select(effective, starts_with("event")) %>%
  unique()
```


### words
asdfadk;




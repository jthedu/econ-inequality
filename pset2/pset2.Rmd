---
title: "Inequality PSet 2 - Question #5f (code part)"
author: "Julia Du"
date: "`r lubridate::today()`"
output: pdf_document
---

*Note to self*: Because Latex doesn't like "##" from the tibbles printed here, be sure to delete cache folder when re-knitting .Rmd

## Load necessary libraries
```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(lubridate)
library(broom)
library(stats)
library(ivreg)
library(lmtest)
library(sandwich)
library(moderndive)
library(kableExtra)
library(tinytex)
library(stargazer)

theme_set(theme_minimal())
```


## Question 5a

The causal relationship of interest is the effect of medical expenditures on health outcomes - in this case, the effect of additional infant health care on mortality outcomes of infants. 

The structural equation can be seen as: 

$$infant\:mortality = a_i + \beta_1(health\:inputs) + a_t + a_s + \delta X'_i + \epsilon_i$$

$$infant\:mortality = a_i + \beta_1(health\:inputs)  + a_2VLBW_i \times(g_i - 1500) \\ + a_3(1-VLBW_I) \times (g_i-1500)+ a_t + a_s + \delta X'_i + \epsilon_i$$


$a_t$, $a_s$, $X'_i$ are essentially control variables, being  indicators for each year t of birth, state s of birth, and newborn characteristics respectively. 

## Question 5b

The problem with estimating this equation in cross-sectional data is that FINISH THIS!!!

## Question 5c

The instrument here is the Very Low Birthweight (VLBW) indicator, which is a dummy that indicates if the newborn was classified as weighing strictly less than 1500 grams. 

VLBW as an instrument allows us to get an unbiased estimate of the causal relationship because ...

## Question 5d

The "first-stage" equation is: 
$$Y_i = b_0 + b_1VLBW_i + b_2VLBW_i \times(g_i - 1500) \\ + b_3(1-VLBW_I) \times (g_i-1500) + b_t + b_s + \delta X_i' + e_i$$

where $Y_i$ is the health inputs (aka costs). 

###This looks at the effects that VLBW has on health inputs given differences in weight.  

The "reduced form" regression is: 
$$Y_i = a_0 + a_1VLBW_i + a_2VLBW_i \times(g_i - 1500) \\ + a_3(1-VLBW_I) \times (g_i-1500) + a_t + a_s + \delta X_i' + \epsilon_i$$
where $Y_i$ is one-year mortality.

As you can see, there's a great deal of similarity between these two equations. The variables are: 

* $VLBW_i$ is the indicator instrumental variable on whether the newborn was classified as VLBW. 
* $VLBW_i \times(g_i - 1500)$ is how far below the cutoff of 1500 g the infant is (if they are indeed below the cutoff). 
* $(1-VLBW_I) \times (g_i-1500)$ is how far above the cutoff the infant is (if they are indeed above the cutoff).
* $g_i$ is infant i's weight in grams
* $b_t$ and $a_t$ are indicators for each year of birth t (essentially controls)
* $b_s$ and $a_s$ are indicators for each state of birth s (essentially controls)
* $X_i'$ are newborn characteristics (essentially control variables)

So similarly, the coefficients are (I will be writing just the $a$ coefficients here, but they describe the same effect on mortality as the $b$ coefficients have on health inputs): 
* $a_1$ and $b_1$ are the effect of VLBW on outcome $Y_i$ (i.e. mortality outcome for $a_1$ & health input for $b_1$)
* $a_2$ is the effect of VLBW on $Y_i$ if the infant is below the cutoff of 1500 grams 
* $a_2$ is the effect of VLBW on $Y_i$ if the infant is above the cutoff of 1500 grams
* $\delta$ is the effect of the infant characteristics $X_i'$ on outcome $Y_i$

## Question 5e

instrument is VLBW (below cutoff or not)
D is whether or not they get the treatment. the relevance assumption is that there is a discontinuous jump in medical inputs at the cutoff

## Question 5f(i): Construct the outcome variables
```{r}
#import the dataset
q2 <- read_csv("./DataExercise_RD/adkw.csv") 

#graph Figure 2A
q2 %>%
  mutate(bin = cut_width(x = dbirwt, width = 28.3495, center = 1500)) %>%
  drop_na(death1year) %>% 
  group_by(bin) %>%
  summarize(med_bin = median(dbirwt), mean_death1year = mean(death1year)) %>%
  ggplot()+
  geom_point(mapping = aes(x = med_bin, y = mean_death1year)) + 
  geom_vline(xintercept = 1500) +
  labs(x = "median birthweight (g)", y = "mean one-yr mortality", title = "2f(i) Graph")
```


## Question 5f(ii)

**5f(ii).A**

```{r}
q2 %>%
  mutate(bin = cut_width(x = dbirwt, width = 28.3495, center = 1500)) %>%
  drop_na(death1year, gestat) %>% 
  group_by(bin) %>%
  summarize(med_bin = median(dbirwt), mean_death1year = mean(death1year), 
            mean_gestat = mean(gestat))%>%
  ggplot()+
  geom_point(mapping = aes(x = med_bin, y = mean_gestat)) + 
  geom_vline(xintercept = 1500) +
  labs(x = "median birth weight (g)", y = "mean gestational age (wks)", 
       title = "2f(ii) Graph") 
```

**5f(ii).B**

This figure supports the RD identifying assumption that covariates of interest (gestational age) are continuous with regard to the running variable (mortality). This helps us conclude that the treatment assignment is as good as random since the baseline characteristic  below and above the cutoff of 1500 grams have similar distributions.

## 5f(iii)

```{r}
q2_reg_data <- q2 %>%
  mutate(bin = cut_width(x = dbirwt, width = 28.3495, center = 1500)) %>%
  group_by(bin) %>%
  mutate(VLBW = if_else(dbirwt < 1500, 1, 0)) %>%
  mutate(VLBW2 = VLBW*(dbirwt-1500)/100,
         VLBW3 = (1-VLBW)*(dbirwt-1500)/100)
# divide by 100 since paper has values in (100s) for those variables

# estimate reduced form eqn by OLS
q2_ols <- lm(death1year ~ VLBW + VLBW2 + VLBW3, data = q2_reg_data)

coeftest(q2_ols, vcov = vcovHC(q2_ols, type = "HC1"))

# helpful link on printing stargazer table:
# https://stackoverflow.com/questions/45724432/stargazer-output-is-code-not-a-table
```

```{r latextable, results = "asis"}
stargazer(q2_ols, type = "latex", title = "5f(iii).C", digits = 4)
```


```{r}
```
